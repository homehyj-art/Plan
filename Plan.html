<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì¸ìƒ ì—­ì „! ë¼ì´í”„ ì¹´ë“œ ê²Œì„ (Firebase ì§€ì›)</title>
<link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
<style>
  :root{--bg:#fff7fb;--card:#fff;--muted:#6b7280;--accent:#7c3aed}
  body{font-family:'Jua',sans-serif;background:linear-gradient(135deg,#fef6ff,#f0f9ff);margin:0;color:#111}
  .wrap{max-width:1000px;margin:30px auto;padding:18px}
  header{display:flex;justify-content:space-between;align-items:center}
  .title{font-size:28px}
  .board{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.06);margin-top:12px}
  .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .stat{background:#fafafa;border-radius:12px;padding:8px}
  .bar{height:10px;background:#e6edf7;border-radius:999px;overflow:hidden}
  .fill{height:100%}
  .K{background:#93c5fd}.S{background:#86efac}.R{background:#fca5a5}.T{background:#fbcfe8}
  .card{margin-top:12px;padding:14px;border-radius:14px;background:#fff}
  .choices{display:grid;gap:8px;margin-top:8px}
  button.choice{padding:10px;border-radius:10px;border:0;background:#f1f5f9;text-align:left;cursor:pointer}
  .controls{display:flex;gap:8px}
  .btn{padding:8px 12px;border-radius:10px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  .muted{background:#e5e7eb;color:#111}
  .side{display:grid;gap:12px;margin-top:12px}
  .log{max-height:240px;overflow:auto;padding:8px;background:#fff;border-radius:12px}
  .dream{padding:8px;background:#fff;border-radius:12px}
  .ending{padding:12px;background:#fff;border-radius:12px;margin-top:12px}
  .small{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="title">ğŸƒ ì¸ìƒ ì—­ì „! ë¼ì´í”„ ì¹´ë“œ ê²Œì„</div>
      <div class="small">ì¹´ë“œë¡œ ì„ íƒí•˜ê³ , ëŠ¥ë ¥ì¹˜ ë³€í™”ë¡œ ë‚˜ë§Œì˜ ì—”ë”©ì„ ì°¾ì•„ë³´ì.</div>
    </div>
    <div class="controls">
      <button id="nextBtn" class="btn">ë‹¤ìŒ ì¹´ë“œ</button>
      <button id="resetBtn" class="btn muted">ì²˜ìŒë¶€í„°</button>
    </div>
  </header>

  <main class="board">
    <section class="stats" id="stats">
      <div class="stat"><div>ğŸ“˜ ì§€ì‹ <span id="valK" class="small"></span></div><div class="bar"><div id="barK" class="fill K" style="width:0%"></div></div></div>
      <div class="stat"><div>ğŸ’ª ì²´ë ¥ <span id="valS" class="small"></span></div><div class="bar"><div id="barS" class="fill S" style="width:0%"></div></div></div>
      <div class="stat"><div>ğŸ¤ ì¸ê°„ê´€ê³„ <span id="valR" class="small"></span></div><div class="bar"><div id="barR" class="fill R" style="width:0%"></div></div></div>
      <div class="stat"><div>âœ¨ ì¬ëŠ¥ <span id="valT" class="small"></span></div><div class="bar"><div id="barT" class="fill T" style="width:0%"></div></div></div>
    </section>

    <article class="card" id="cardArea">
      <h3 id="cardTitle">ë¡œë”© ì¤‘...</h3>
      <p id="cardText"></p>
      <div class="choices" id="choices"></div>
    </article>

    <div style="display:grid;grid-template-columns:1fr 320px;gap:16px;margin-top:12px">
      <div>
        <div class="card log">
          <strong>ğŸ“ ì„ íƒ ê¸°ë¡</strong>
          <div id="log" style="margin-top:8px"></div>
        </div>

        <div id="endingBox" class="ending" style="display:none"></div>
      </div>

      <aside class="side">
        <div class="dream">
          <strong>ğŸ† ë‚˜ì˜ ê¿ˆ ë°œí‘œ ëŒ€íšŒ</strong>
          <div class="small">ê²°ê³¼ì™€ í•¨ê»˜ â€˜ë‚˜ì˜ ê¿ˆâ€™ì„ ì €ì¥í•´ìš” (êµì‚¬/í•™ìƒ ì—´ëŒ ê°€ëŠ¥)</div>
          <input id="dreamName" placeholder="ì´ë¦„(ì„ íƒ)" style="width:100%;margin-top:8px;padding:8px;border-radius:8px;border:1px solid #eee" />
          <textarea id="dreamText" rows="4" placeholder="ë‚˜ì˜ ê¿ˆ/ì§„ë¡œ" style="width:100%;margin-top:8px;padding:8px;border-radius:8px;border:1px solid #eee"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="saveDream" class="btn">ë“±ë¡</button>
            <button id="loadDreams" class="btn muted">ìƒˆë¡œê³ ì¹¨</button>
          </div>
        </div>

        <div class="card log">
          <strong>ì„œë²„ ìƒíƒœ / ë¡œì»¬ ì €ì¥</strong>
          <div id="status" class="small" style="margin-top:8px">Firebase: ë¯¸ì„¤ì • (ì„ íƒ)</div>
        </div>

        <div class="card log">
          <strong>ê´€ë¦¬ì ë„êµ¬</strong>
          <div style="margin-top:8px">
            <button id="exportLocal" class="btn muted">ë¡œì»¬ê²°ê³¼ ë‚´ë³´ë‚´ê¸°</button>
            <button id="clearLocal" class="btn muted">ë¡œì»¬ ê¸°ë¡ ì „ì²´ ì‚­ì œ</button>
          </div>
        </div>
      </aside>
    </div>
  </main>
</div>

<!-- Firebase (optional) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
/*
  ì„¤ì •: ì•„ë˜ FIREBASE_CONFIG ì— ë³¸ì¸ Firebase ì½˜ì†”ì˜ ì„¤ì •ì„ ë„£ìœ¼ì„¸ìš”.
  ì˜ˆ:
  const FIREBASE_CONFIG = {
    apiKey: "API_KEY",
    authDomain: "PROJECT_ID.firebaseapp.com",
    projectId: "PROJECT_ID",
    storageBucket: "PROJECT_ID.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
  };
*/
const FIREBASE_CONFIG = null; // <-- ì—¬ê¸°ì— ê°ì²´ë¥¼ ë„£ìœ¼ë©´ Firestoreë¡œ ì €ì¥í•©ë‹ˆë‹¤.

let db = null;
if (FIREBASE_CONFIG) {
  try {
    const app = firebase.initializeApp(FIREBASE_CONFIG);
    db = firebase.firestore();
    document.getElementById('status').textContent = 'Firebase: ì—°ê²° ì„±ê³µ';
  } catch(e) {
    console.error('Firebase init error', e);
    document.getElementById('status').textContent = 'Firebase: ì—°ê²° ì‹¤íŒ¨ (ì½˜ì†” í™•ì¸)';
  }
} else {
  document.getElementById('status').textContent = 'Firebase: ë¯¸ì„¤ì • (ì˜µì…˜). localStorageë¡œ ì €ì¥ë©ë‹ˆë‹¤.';
}
</script>

<script>
(async function(){
  // ê¸°ë³¸ ìƒíƒœ
  const MAX_STEPS = 8;
  const defaultStats = {K:40,S:40,R:40,T:40};
  let state = { step:0, stats:{...defaultStats}, history:[], cards:[], endings:[] };

  // UI ë ˆí¼ëŸ°ìŠ¤
  const barK = document.getElementById('barK'), barS = document.getElementById('barS'),
        barR = document.getElementById('barR'), barT = document.getElementById('barT');
  const valK = document.getElementById('valK'), valS = document.getElementById('valS'),
        valR = document.getElementById('valR'), valT = document.getElementById('valT');
  const cardTitle = document.getElementById('cardTitle'), cardText = document.getElementById('cardText'), choicesBox = document.getElementById('choices');
  const logBox = document.getElementById('log'), endingBox = document.getElementById('endingBox');

  // JSON ë¶ˆëŸ¬ì˜¤ê¸° (cards.json + endings.json)
  async function loadJSON(path, fallback) {
    try {
      const r = await fetch(path);
      if(!r.ok) throw new Error('fetch fail');
      return await r.json();
    } catch(e) {
      console.warn('fetch failed', path, e);
      return fallback;
    }
  }

  const fallbackCards = [
    {"id":1,"title":"ì¤‘í•™êµ ì…í•™!","text":"ì²«ë‚ , ì˜†ìë¦¬ ì¹œêµ¬ì—ê²Œ ë¨¼ì € ë§ì„ ê±¸ê¹Œ?","choices":[{"label":"ìš©ê¸°ë‚´ì„œ ë¨¼ì € ì¸ì‚¬í•œë‹¤","delta":{"R":6,"S":1}},{"label":"ì¡°ìš©íˆ êµì‹¤ì„ ë‘˜ëŸ¬ë³¸ë‹¤","delta":{"K":3}}]}
  ];
  const fallbackEndings = [{"id":"balanced-1","title":"ê· í˜•í˜• ì§ì—…ì¸","desc":"ê· í˜• ì¡íŒ ì‚¶","tags":["ê· í˜•"],"preferred":"ANY","threshold":0}];

  state.cards = await loadJSON('cards.json', fallbackCards);
  state.endings = await loadJSON('endings.json', fallbackEndings);

  function clamp(v){ return Math.max(0, Math.min(100, v)); }

  function renderStats(){
    const s = state.stats;
    barK.style.width = s.K + "%"; barS.style.width = s.S + "%";
    barR.style.width = s.R + "%"; barT.style.width = s.T + "%";
    valK.textContent = s.K; valS.textContent = s.S; valR.textContent = s.R; valT.textContent = s.T;
  }

  function logPush(text){
    state.history.unshift({text, at: new Date().toISOString()});
    const div = document.createElement('div'); div.textContent = 'â€¢ ' + text;
    logBox.prepend(div);
  }

  function applyDelta(delta){
    for(const k in delta){
      if(state.stats.hasOwnProperty(k)){
        state.stats[k] = clamp(state.stats[k] + delta[k]);
      }
    }
  }

  function showCard(index){
    const card = state.cards[index % state.cards.length];
    cardTitle.textContent = card.title;
    cardText.textContent = card.text;
    choicesBox.innerHTML = '';
    card.choices.forEach((c,i)=>{
      const btn = document.createElement('button');
      btn.className = 'choice';
      btn.textContent = c.label;
      btn.onclick = async () => {
        applyDelta(c.delta);
        renderStats();
        logPush(`[${card.title}] â†’ ${c.label}`);
        state.step++;
        if(state.step >= MAX_STEPS) {
          await finish();
        } else {
          showCard(state.step);
        }
      };
      choicesBox.appendChild(btn);
    });
  }

  async function finish(){
    // ì—”ë”© ì„ íƒ ë¡œì§: ìš°ì„  ìµœëŒ€ ëŠ¥ë ¥ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í›„ë³´ë“¤ í•„í„° â†’ ê°€ì¥ ë†’ì€ threshold ë§Œì¡± ì—”ë”© ì„ íƒ â†’ ì—†ìœ¼ë©´ ANY ê³„ì—´ ì„ íƒ
    const s = state.stats;
    const maxVal = Math.max(s.K, s.S, s.R, s.T);
    const preferred = (s.K === maxVal ? 'K' : s.S === maxVal ? 'S' : s.R === maxVal ? 'R' : 'T');

    // í›„ë³´ í•„í„°
    let candidates = state.endings.filter(e => (e.preferred === 'ANY' || e.preferred === preferred) && (e.threshold <= maxVal));
    if(candidates.length === 0){
      // ì¢€ ë” ê´€ëŒ€í•˜ê²Œ threshold ë¬´ì‹œ
      candidates = state.endings.filter(e => (e.preferred === 'ANY' || e.preferred === preferred));
    }
    // ëœë¤ì„± + ê°„ë‹¨í•œ ìš°ì„ ìˆœìœ„: threshold ë†’ì€ ê²ƒ ìš°ì„ 
    candidates.sort((a,b)=> (b.threshold||0) - (a.threshold||0));
    const chosen = candidates.length ? candidates[0] : {title:'ë¯¸ì •',desc:'ë‹¤ì–‘í•œ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.'};

    // ë Œë”
    endingBox.style.display = 'block';
    endingBox.innerHTML = `<div style="font-size:18px"><strong>${chosen.title}</strong></div>
                           <div style="margin-top:6px">${chosen.desc}</div>
                           <div style="margin-top:8px"><small class="small">í•µì‹¬ ìˆ˜ì¹˜: ${preferred} (${maxVal})</small></div>`;

    // ì €ì¥
    await saveRecordToServer();
  }

  // ë¡œì»¬ + ì„œë²„ ì €ì¥ í•¨ìˆ˜
  function saveLocalRecord(){
    const arr = JSON.parse(localStorage.getItem('lifeGameRecords')||'[]');
    arr.push({date:new Date().toISOString(), stats: state.stats, history: state.history});
    localStorage.setItem('lifeGameRecords', JSON.stringify(arr));
  }

  async function saveRecordToServer(){
    saveLocalRecord();
    if(window.db){
      try {
        await db.collection('lifeGameRecords').add({createdAt: new Date(), stats: state.stats, history: state.history});
        console.log('saved to Firestore');
      } catch(e){ console.warn('Firestore save failed', e); }
    }
  }

  // ê¿ˆ ì €ì¥
  document.getElementById('saveDream').onclick = async ()=>{
    const name = document.getElementById('dreamName').value.trim();
    const text = document.getElementById('dreamText').value.trim();
    if(!text){ alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
    const rec = {name: name || 'ìµëª…', text, createdAt: new Date().toISOString()};
    // local
    const arr = JSON.parse(localStorage.getItem('lifeGameDreams')||'[]'); arr.push(rec); localStorage.setItem('lifeGameDreams', JSON.stringify(arr));
    alert('ì €ì¥ë¨ (ë¡œì»¬). Firebase ì„¤ì • ì‹œ ì„œë²„ì— ì €ì¥ë©ë‹ˆë‹¤.');
    // server
    if(window.db){
      try {
        await db.collection('lifeGameDreams').add({name: rec.name, text: rec.text, createdAt: new Date()});
        alert('ì„œë²„ì—ë„ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch(e){ console.warn('dream save fail', e); }
    }
  };

  document.getElementById('loadDreams').onclick = ()=>{
    const arr = JSON.parse(localStorage.getItem('lifeGameDreams')||'[]');
    if(arr.length === 0) { alert('ì €ì¥ëœ ë°œí‘œê°€ ì—†ìŠµë‹ˆë‹¤ (ë¡œì»¬).'); return; }
    let html = '';
    arr.slice().reverse().forEach(a => { html += `<div style="margin-bottom:6px"><strong>${a.name}</strong><div style="font-size:13px">${a.text}</div><div class="small">${new Date(a.createdAt).toLocaleString()}</div></div>`; });
    alert('ë¡œì»¬ ë°œí‘œ ëª©ë¡:\n\n' + arr.map(a => `${a.name}: ${a.text}`).join('\n'));
  };

  // ê´€ë¦¬ì ë²„íŠ¼ë“¤
  document.getElementById('exportLocal').onclick = ()=>{
    const arr = JSON.parse(localStorage.getItem('lifeGameRecords')||'[]');
    const blob = new Blob([JSON.stringify(arr,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'lifeGameRecords.json'; a.click();
    URL.revokeObjectURL(url);
  };
  document.getElementById('clearLocal').onclick = ()=>{
    if(confirm('ë¡œì»¬ ê¸°ë¡ì„ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?')){ localStorage.removeItem('lifeGameRecords'); localStorage.removeItem('lifeGameDreams'); alert('ì‚­ì œë¨'); }
  };

  // next/reset ë²„íŠ¼
  document.getElementById('nextBtn').onclick = ()=> {
    if(state.step >= MAX_STEPS){ alert('ì´ë¯¸ ëª¨ë“  ì¹´ë“œë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ì²˜ìŒë¶€í„° ì‹œì‘í•˜ì„¸ìš”.'); return; }
    showCard(state.step);
  };
  document.getElementById('resetBtn').onclick = ()=> {
    if(!confirm('ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í• ê¹Œìš”? í˜„ì¬ ì§„í–‰ì€ ì €ì¥ë©ë‹ˆë‹¤.')) return;
    state.step = 0; state.stats = {...defaultStats}; state.history = []; logBox.innerHTML = ''; endingBox.style.display='none'; renderStats();
  };

  // ì´ˆê¸° ë Œë”
  renderStats();
  // í”„ë¦¬ë·°: ìë™ ì²« ì¹´ë“œ ë¡œë”©í•˜ì§€ ì•ŠìŒ â€” 'ë‹¤ìŒ ì¹´ë“œ' í´ë¦­ìœ¼ë¡œ ì‹œì‘
})();
</script>
</body>
</html>
