<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>📜 다중지능 탐험: 고대의 부름</title>
<link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Cinzel:wght@700&display=swap" rel="stylesheet">
<style>
    /* VARIABLES AND BASIC STYLES */
    :root {
        --brown-text: #4a3a2a;
        --gold: #c89a4b;
        --card-bg: rgba(255, 255, 255, 0.85);
        --btn-bg: #8d6e63;
        --btn-hover: #795548;
    }

    * {
        box-sizing: border-box;
    }

    body {
        margin: 0;
        font-family: 'Gowun Dodum', serif;
        background-color: #5d4037; /* Background color before image loads */
        background-image: url('https://firebasestorage.googleapis.com/v0/b/gtemp-a8599.appspot.com/o/papyrus-1478204_1280.jpg?alt=media&token=26214300-84c4-42ea-a4b5-65476d0d216a');
        background-repeat: no-repeat;
        background-position: center center;
        background-size: cover;
        color: var(--brown-text);
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
        line-height: 1.6;
        font-size: 16px; /* Base font size adjusted for readability */
    }

    h1, h2, h3 {
        font-family: 'Cinzel', serif;
        color: var(--gold);
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    h1 {
        font-size: 2.5rem; /* Larger font for main title */
        margin: 0;
        letter-spacing: 2px;
    }

    h3 {
        font-size: 1.8rem;
        margin-top: 0;
        letter-spacing: 1px;
    }

    .wrap {
        width: 100%;
        max-width: 1200px;
    }

    .card {
        background-color: var(--card-bg);
        border-radius: 15px;
        padding: 40px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        animation: fadeIn 1s ease-out;
        transition: transform 0.3s ease;
        text-align: center;
        margin-top: 20px;
    }

    .card:hover {
        transform: translateY(-5px);
    }

    .header, .footer {
        text-align: center;
        margin-bottom: 20px;
        color: #fff;
    }

    .btn {
        display: inline-block;
        padding: 12px 25px;
        margin: 10px 5px;
        font-family: 'Gowun Dodum', sans-serif;
        font-size: 1rem;
        color: #fff;
        background-color: var(--btn-bg);
        border: none;
        border-radius: 25px;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .btn:hover {
        background-color: var(--btn-hover);
        box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .input-group {
        margin-bottom: 20px;
    }

    .input-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .input-group input {
        width: 100%;
        padding: 10px;
        border: 2px solid #ccc;
        border-radius: 10px;
        font-size: 1rem;
    }

    /* STATS PANEL & BAR */
    #stats-panel {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-top: 20px;
        padding: 20px;
        background-color: var(--card-bg);
        border-radius: 15px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    .stat {
        background-color: #f7f3ed;
        border-radius: 10px;
        padding: 15px;
        box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
    }

    .bar {
        height: 20px;
        background-color: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 5px;
    }

    .bar-inner {
        height: 100%;
        background-color: var(--gold);
        transition: width 1s ease-in-out;
    }

    /* RESULT AREA */
    #result-area {
        display: none;
        text-align: center;
    }

    #result-area h3, #dashboard-area h3 {
        text-align: center;
    }

    /* DASHBOARD AREA */
    #dashboard-area {
        display: none;
        text-align: center;
    }

    .class-dashboard {
        background-color: var(--card-bg);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .class-header {
        font-weight: bold;
        color: var(--gold);
        font-size: 1.5rem;
        margin-bottom: 15px;
    }

    .dashboard-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .dashboard-stat {
        background-color: #f7f3ed;
        border-radius: 10px;
        padding: 10px;
        text-align: left;
    }

    .dashboard-stat .bar {
        background-color: #e0e0e0;
        height: 15px;
    }

    .dashboard-stat .bar-inner {
        background-color: var(--gold);
    }

    .dashboard-stat-name {
        font-weight: bold;
        color: var(--brown-text);
        font-size: 0.9rem;
    }

    .dashboard-stat-value {
        font-weight: bold;
        color: var(--gold);
        font-size: 1rem;
        margin-left: 5px;
    }

    .dashboard-loading {
        font-style: italic;
        color: var(--brown-text);
    }

    /* GAME AREA */
    #game-area {
        display: none;
    }
    #game-area h2 {
        font-size: 1.5rem;
    }
    #game-area p {
        font-size: 1.1rem;
    }

    /* MOBILE RESPONSIVENESS */
    @media (max-width: 768px) {
        body {
            font-size: 14px;
        }

        h1 {
            font-size: 2rem;
        }

        .card {
            padding: 20px;
        }

        .btn {
            font-size: 0.9rem;
            padding: 10px 20px;
        }

        #stats-panel, .dashboard-stats {
            grid-template-columns: 1fr;
        }
    }
</style>
</head>
<body>
<div class="wrap">
    <!-- START SCREEN -->
    <div id="start-screen">
        <div class="header">
            <h1>📜 다중지능 탐험: 고대의 부름</h1>
        </div>
        <div class="card">
            <h2>고대의 비밀을 찾아 떠나는 모험</h2>
            <p>이 게임은 '하워드 가드너'의 다중지능 이론을 기반으로 당신의 강점을 탐색하는 모험입니다. 당신은 고대 유적지에서 발견된 지혜의 서판을 따라 신비로운 퀘스트를 해결하게 됩니다. 각 선택은 당신의 숨겨진 지능을 깨우는 열쇠가 될 것입니다.</p>
            <div class="input-group">
                <label for="player-name">탐험가 이름:</label>
                <input type="text" id="player-name" placeholder="이름을 입력하세요" />
            </div>
            <div class="input-group">
                <label for="player-class">탐험가 반:</label>
                <input type="number" id="player-class" placeholder="반을 입력하세요 (예: 1)" min="1" max="99" />
            </div>
            <button class="btn" onclick="startGame()">모험 시작하기</button>
            <button class="btn" onclick="showDashboard()">대시보드 보기</button>
        </div>
    </div>

    <!-- GAME AREA -->
    <div id="game-area">
        <div class="card">
            <h2 id="quest-title"></h2>
            <p id="quest-text"></p>
            <div id="options-container"></div>
        </div>
    </div>

    <!-- STATS AND RESULT AREA -->
    <div id="result-area">
        <div class="card">
            <h2 id="result-title"></h2>
            <p id="result-message"></p>
            <p>당신의 지능 분포는 다음과 같습니다:</p>
            <div id="stats-panel"></div>
            <p id="result-description" style="margin-top: 20px; font-style: italic;"></p>
            <button class="btn" onclick="showDashboard()">대시보드 보기</button>
            <button class="btn" onclick="resetGame()">다시 시작하기</button>
        </div>
    </div>
    
    <!-- DASHBOARD AREA -->
    <div id="dashboard-area">
        <div class="header">
            <h2>전체 모험 결과 대시보드</h2>
        </div>
        <div class="card">
            <div id="dashboard-content">
                <p class="dashboard-loading">대시보드 데이터를 불러오는 중...</p>
            </div>
            <button class="btn" onclick="resetGame()">다시 시작하기</button>
        </div>
    </div>

    <div class="footer">
        <p>&copy; 고대 유적지, 2025</p>
    </div>
</div>

<script type="module">
    // Firebase imports. Using specific CDN paths for HTML context.
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- FIREBASE SETUP (MANDATORY) ---
    // DO NOT change these variables. They are automatically provided by the platform.
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app;
    let db;
    let auth;
    let userId;
    let isAuthReady = false;

    // A function to get an element by its ID
    const el = id => document.getElementById(id);

    // Initial game state
    let player = {};
    let currentQuestIndex = 0;
    let scores = {
        linguistic: 0,
        logical: 0,
        spatial: 0,
        bodily: 0,
        musical: 0,
        interpersonal: 0,
        intrapersonal: 0,
        naturalist: 0
    };

    // User-provided quests. Do not modify as per user's request.
    const quests = [
        {
            title: "첫 번째 서판: 미로의 방",
            text: "고대 유적지 깊숙한 곳, 미로의 방에 들어섰습니다. 올바른 길을 선택해야 합니다.",
            options: [
                { text: "천장에 새겨진 별자리 지도를 해독하며 길을 찾습니다.", effect: { spatial: 10, logical: 5 } },
                { text: "미로의 벽에 손을 얹고 재질의 변화를 느끼며 길을 찾습니다.", effect: { bodily: 10, naturalist: 5 } },
                { text: "다른 사람의 발자국이 가장 많은 길을 따라갑니다.", effect: { interpersonal: 10, logical: 5 } },
                { text: "미로 벽의 낙서를 읽어 숨겨진 힌트를 찾습니다.", effect: { linguistic: 10, spatial: 5 } }
            ]
        },
        {
            title: "두 번째 서판: 고대의 퍼즐",
            text: "중앙 홀에 도착하니, 고대 문양들이 새겨진 거대한 퍼즐이 나타납니다.",
            options: [
                { text: "문양의 수학적 패턴을 분석해 퍼즐을 맞춥니다.", effect: { logical: 10, spatial: 5 } },
                { text: "퍼즐 조각을 만져보며 감촉에 따라 알맞은 위치를 찾습니다.", effect: { bodily: 10, spatial: 5 } },
                { text: "퍼즐 조각의 모양을 시각화하며 공간을 채웁니다.", effect: { spatial: 10, logical: 5 } },
                { text: "주변에 적혀있는 시를 읊으며 퍼즐에 답을 찾습니다.", effect: { linguistic: 10, musical: 5 } }
            ]
        },
        {
            title: "세 번째 서판: 침묵의 전당",
            text: "어두운 전당에 들어서자, 침묵만이 감도는 가운데 신비로운 선율이 들립니다.",
            options: [
                { text: "자신만의 선율을 덧붙여 새로운 음악을 창조합니다.", effect: { musical: 10, intrapersonal: 5 } },
                { text: "선율의 화음을 분석해 다음 음계를 예측합니다.", effect: { logical: 10, musical: 5 } },
                { text: "음악의 리듬에 맞춰 춤을 추며 전당을 가로지릅니다.", effect: { bodily: 10, musical: 5 } },
                { text: "자신이 가장 좋아하는 음악을 떠올리며 마음을 다스립니다.", effect: { intrapersonal: 10, musical: 5 } }
            ]
        },
        {
            title: "네 번째 서판: 비밀의 정원",
            text: "비밀의 정원에는 낯선 식물들이 가득합니다.",
            options: [
                { text: "식물들의 생김새와 특성을 관찰하여 숨겨진 길을 찾습니다.", effect: { naturalist: 10, spatial: 5 } },
                { text: "가장 아름다운 꽃을 찾아 향기를 맡습니다.", effect: { musical: 10, naturalist: 5 } },
                { text: "식물의 성장 패턴을 분석해 생명력을 이해합니다.", effect: { logical: 10, naturalist: 5 } },
                { text: "식물들과 교감하며 에너지를 느낍니다.", effect: { intrapersonal: 10, interpersonal: 5 } }
            ]
        },
        {
            title: "다섯 번째 서판: 왕의 회의실",
            text: "왕의 회의실에 도착하자 여러 개의 석상이 당신을 바라보고 있습니다.",
            options: [
                { text: "각각의 석상이 상징하는 감정을 이해하고 그들의 관계를 파악합니다.", effect: { interpersonal: 10, intrapersonal: 5 } },
                { text: "석상들의 몸짓을 따라하며 그들의 의도를 파악합니다.", effect: { bodily: 10, interpersonal: 5 } },
                { text: "석상들 사이의 언어적 패턴을 찾아냅니다.", effect: { linguistic: 10, logical: 5 } },
                { text: "석상들이 배치된 공간의 의미를 해석합니다.", effect: { spatial: 10, interpersonal: 5 } }
            ]
        }
    ];

    // --- CORE GAME LOGIC ---

    // Function to show a specific screen
    function showScreen(screenId) {
        el('start-screen').style.display = 'none';
        el('game-area').style.display = 'none';
        el('result-area').style.display = 'none';
        el('dashboard-area').style.display = 'none';
        el(screenId).style.display = 'block';
    }

    // Start the game
    function startGame() {
        const name = el('player-name').value.trim();
        const playerClass = el('player-class').value.trim();

        if (!name) {
            // Replaced alert with custom modal logic
            showCustomAlert('이름을 입력해주세요.');
            return;
        }

        if (!playerClass || isNaN(playerClass) || parseInt(playerClass) < 1) {
            // Replaced alert with custom modal logic
            showCustomAlert('유효한 반 번호를 입력해주세요.');
            return;
        }

        player = {
            name: name,
            clazz: parseInt(playerClass)
        };

        // Reset scores for a new game
        Object.keys(scores).forEach(key => scores[key] = 0);
        currentQuestIndex = 0;
        showScreen('game-area');
        loadQuest();
    }

    // Load the current quest
    function loadQuest() {
        if (currentQuestIndex >= quests.length) {
            showResult();
            return;
        }

        const quest = quests[currentQuestIndex];
        el('quest-title').textContent = quest.title;
        el('quest-text').textContent = quest.text;

        const optionsContainer = el('options-container');
        optionsContainer.innerHTML = '';
        quest.options.forEach(option => {
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.textContent = option.text;
            btn.onclick = () => selectOption(option.effect);
            optionsContainer.appendChild(btn);
        });
    }

    // Handle option selection
    function selectOption(effects) {
        for (const key in effects) {
            if (scores[key] !== undefined) {
                scores[key] += effects[key];
            }
        }
        currentQuestIndex++;
        loadQuest();
    }

    // Display the final result
    async function showResult() {
        showScreen('result-area');
        el('result-title').textContent = `📜 모험의 결과`;
        el('result-message').innerHTML = `<strong>${player.name}</strong>(${player.clazz}반), 고대의 부름에 응답해주셔서 감사합니다. 당신의 지능 분포는 다음과 같이 나타났습니다.`;
        el('result-description').innerHTML = ''; // Clear previous message

        // Display stats bars
        renderStatsBars();

        // Determine top intelligences
        const entries = Object.entries(scores).sort((a, b) => b[1] - a[1]);
        const top1 = entries[0][0];
        const top2 = entries[1][0];
        const mapNames = {
            linguistic: '언어 지능',
            logical: '논리-수학 지능',
            spatial: '공간 지능',
            bodily: '신체-운동 지능',
            musical: '음악 지능',
            interpersonal: '대인관계 지능',
            intrapersonal: '자기이해 지능',
            naturalist: '자연친화 지능'
        };
        const description = `이번 모험을 통해 <strong>${mapNames[top1]}</strong>과 <strong>${mapNames[top2]}</strong>이(가) 당신의 가장 높은 지능임을 알 수 있습니다. 이 지능들을 계속해서 발전시켜 나가세요!`;
        el('result-description').innerHTML = description;
        
        // Save results to Firestore
        if (isAuthReady) {
            try {
                const resultsRef = collection(db, `artifacts/${appId}/public/data/multiple_intelligence_results`);
                await addDoc(resultsRef, {
                    name: player.name,
                    class: player.clazz,
                    scores: scores,
                    timestamp: new Date()
                });
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        }
    }

    // Render the stats bars
    function renderStatsBars(targetElementId = 'stats-panel', scoresToRender = scores) {
        const root = el(targetElementId);
        root.innerHTML = ''; // Clear previous bars
        const mapNames = {
            linguistic: '언어 지능',
            logical: '논리-수학 지능',
            spatial: '공간 지능',
            bodily: '신체-운동 지능',
            musical: '음악 지능',
            interpersonal: '대인관계 지능',
            intrapersonal: '자기이해 지능',
            naturalist: '자연친화 지능'
        };
        Object.keys(scoresToRender).forEach(k => {
            const score = Math.min(100, Math.max(0, scoresToRender[k]));
            const box = document.createElement('div');
            box.className = 'stat';
            box.innerHTML = `
                <div style="font-weight:bold;color:var(--gold);">${mapNames[k]}</div>
                <div class="bar"><div class="bar-inner" style="width:${score}%"></div></div>
            `;
            root.appendChild(box);
        });
    }
    
    // Reset the game to the start screen
    function resetGame() {
        showScreen('start-screen');
    }

    // --- DASHBOARD LOGIC ---
    function showDashboard() {
        showScreen('dashboard-area');
        const dashboardContent = el('dashboard-content');
        dashboardContent.innerHTML = '<p class="dashboard-loading">대시보드 데이터를 불러오는 중...</p>';
        
        if (isAuthReady) {
            const resultsRef = collection(db, `artifacts/${appId}/public/data/multiple_intelligence_results`);
            
            // Listen for real-time updates
            onSnapshot(resultsRef, (querySnapshot) => {
                const resultsByClass = {};
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const classNum = data.class || '알 수 없음';
                    
                    if (!resultsByClass[classNum]) {
                        resultsByClass[classNum] = {
                            count: 0,
                            scores: {
                                linguistic: 0, logical: 0, spatial: 0, bodily: 0,
                                musical: 0, interpersonal: 0, intrapersonal: 0, naturalist: 0
                            }
                        };
                    }
                    
                    resultsByClass[classNum].count++;
                    for (const key in data.scores) {
                        resultsByClass[classNum].scores[key] += data.scores[key];
                    }
                });
                
                renderDashboard(resultsByClass);
            }, (error) => {
                console.error("Error listening to dashboard data: ", error);
                dashboardContent.innerHTML = '<p>데이터를 불러오는 중 오류가 발생했습니다.</p>';
            });
        } else {
            dashboardContent.innerHTML = '<p>데이터베이스 연결이 준비되지 않았습니다. 잠시 후 다시 시도해주세요.</p>';
        }
    }

    // Render the dashboard UI
    function renderDashboard(resultsByClass) {
        const dashboardContent = el('dashboard-content');
        dashboardContent.innerHTML = ''; // Clear loading message

        if (Object.keys(resultsByClass).length === 0) {
            dashboardContent.innerHTML = '<p>아직 저장된 결과가 없습니다. 첫 번째 모험을 시작해보세요!</p>';
            return;
        }

        // Sort classes numerically
        const sortedClasses = Object.keys(resultsByClass).sort((a, b) => {
            if (a === '알 수 없음') return 1;
            if (b === '알 수 없음') return -1;
            return parseInt(a) - parseInt(b);
        });

        sortedClasses.forEach(classNum => {
            const classData = resultsByClass[classNum];
            const avgScores = {};
            const mapNames = {
                linguistic: '언어 지능', logical: '논리-수학 지능', spatial: '공간 지능', bodily: '신체-운동 지능',
                musical: '음악 지능', interpersonal: '대인관계 지능', intrapersonal: '자기이해 지능', naturalist: '자연친화 지능'
            };

            for (const key in classData.scores) {
                avgScores[key] = (classData.scores[key] / classData.count).toFixed(1);
            }

            const classDashboard = document.createElement('div');
            classDashboard.className = 'class-dashboard';
            classDashboard.innerHTML = `
                <div class="class-header">${classNum}반 (${classData.count}명 참여)</div>
                <div class="dashboard-stats">
                    ${Object.keys(avgScores).map(k => `
                        <div class="dashboard-stat">
                            <div class="dashboard-stat-name">${mapNames[k]}</div>
                            <div class="bar"><div class="bar-inner" style="width:${avgScores[k]}%"></div></div>
                        </div>
                    `).join('')}
                </div>
            `;
            dashboardContent.appendChild(classDashboard);
        });
    }

    // Replaced alert with custom modal UI
    function showCustomAlert(message) {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
            z-index: 1000;
        `;
        modal.innerHTML = `
            <div style="background: #fff; padding: 30px; border-radius: 15px; text-align: center; font-size: 1.2rem; font-family: 'Gowun Dodum', sans-serif; color: var(--brown-text);">
                <p>${message}</p>
                <button onclick="this.parentNode.parentNode.remove()" style="padding: 10px 20px; margin-top: 20px; background: var(--btn-bg); color: #fff; border: none; border-radius: 20px; cursor: pointer; font-size: 1rem;">확인</button>
            </div>
        `;
        document.body.appendChild(modal);
    }

    // --- INITIALIZATION ---
    async function initFirebase() {
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Sign in using the provided token or anonymously
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("Firebase initialized and user authenticated:", userId);
                } else {
                    console.log("No user authenticated. Using anonymous sign-in.");
                    isAuthReady = true;
                }
            });
        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }
    }

    // Call the initialization function when the window loads
    window.onload = function() {
        initFirebase();
    };

</script>

</body>
</html>
