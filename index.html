<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ“œ ë‹¤ì¤‘ì§€ëŠ¥ íƒí—˜: ê³ ëŒ€ì˜ ë¶€ë¦„</title>
<link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Cinzel:wght@700&display=swap" rel="stylesheet">
<style>
    /* VARIABLES AND BASIC STYLES */
    :root {
        --brown-text: #4a3a2a;
        --gold: #c89a4b;
        --card-bg: rgba(255, 255, 255, 0.85);
        --btn-bg: #8d6e63;
        --btn-hover: #795548;
    }

    * {
        box-sizing: border-box;
    }

    body {
        margin: 0;
        font-family: 'Gowun Dodum', serif;
        background-color: #5d4037; /* Background color before image loads */
        background-image: url('https://firebasestorage.googleapis.com/v0/b/gtemp-a8599.appspot.com/o/papyrus-1478204_1280.jpg?alt=media&token=26214300-84c4-42ea-a4b5-65476d0d216a');
        background-repeat: no-repeat;
        background-position: center center;
        background-size: cover;
        color: var(--brown-text);
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
        line-height: 1.6;
        font-size: 16px; /* Base font size adjusted for readability */
    }

    h1, h2, h3 {
        font-family: 'Cinzel', serif;
        color: var(--gold);
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    h1 {
        font-size: 2.5rem; /* Larger font for main title */
        margin: 0;
        letter-spacing: 2px;
    }

    h3 {
        font-size: 1.8rem;
        margin-top: 0;
        letter-spacing: 1px;
    }

    .wrap {
        width: 100%;
        max-width: 1200px;
    }

    .card {
        background-color: var(--card-bg);
        border-radius: 15px;
        padding: 40px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        animation: fadeIn 1s ease-out;
        transition: transform 0.3s ease;
        text-align: center;
        margin-top: 20px;
    }

    .card:hover {
        transform: translateY(-5px);
    }

    .header, .footer {
        text-align: center;
        margin-bottom: 20px;
        color: #fff;
    }

    .btn {
        display: inline-block;
        padding: 12px 25px;
        margin: 10px 5px;
        font-family: 'Gowun Dodum', sans-serif;
        font-size: 1rem;
        color: #fff;
        background-color: var(--btn-bg);
        border: none;
        border-radius: 25px;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .btn:hover {
        background-color: var(--btn-hover);
        box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .input-group {
        margin-bottom: 20px;
    }

    .input-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .input-group input {
        width: 100%;
        padding: 10px;
        border: 2px solid #ccc;
        border-radius: 10px;
        font-size: 1rem;
    }

    /* STATS PANEL & BAR */
    #stats-panel {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-top: 20px;
        padding: 20px;
        background-color: var(--card-bg);
        border-radius: 15px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    .stat {
        background-color: #f7f3ed;
        border-radius: 10px;
        padding: 15px;
        box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
    }

    .bar {
        height: 20px;
        background-color: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 5px;
    }

    .bar-inner {
        height: 100%;
        background-color: var(--gold);
        transition: width 1s ease-in-out;
    }

    /* RESULT AREA */
    #result-area {
        display: none;
        text-align: center;
    }

    #result-area h3, #dashboard-area h3 {
        text-align: center;
    }

    /* DASHBOARD AREA */
    #dashboard-area {
        display: none;
        text-align: center;
    }

    .class-dashboard {
        background-color: var(--card-bg);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .class-header {
        font-weight: bold;
        color: var(--gold);
        font-size: 1.5rem;
        margin-bottom: 15px;
    }

    .dashboard-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .dashboard-stat {
        background-color: #f7f3ed;
        border-radius: 10px;
        padding: 10px;
        text-align: left;
    }

    .dashboard-stat .bar {
        background-color: #e0e0e0;
        height: 15px;
    }

    .dashboard-stat .bar-inner {
        background-color: var(--gold);
    }

    .dashboard-stat-name {
        font-weight: bold;
        color: var(--brown-text);
        font-size: 0.9rem;
    }

    .dashboard-stat-value {
        font-weight: bold;
        color: var(--gold);
        font-size: 1rem;
        margin-left: 5px;
    }

    .dashboard-loading {
        font-style: italic;
        color: var(--brown-text);
    }

    /* GAME AREA */
    #game-area {
        display: none;
    }
    #game-area h2 {
        font-size: 1.5rem;
    }
    #game-area p {
        font-size: 1.1rem;
    }

    /* MOBILE RESPONSIVENESS */
    @media (max-width: 768px) {
        body {
            font-size: 14px;
        }

        h1 {
            font-size: 2rem;
        }

        .card {
            padding: 20px;
        }

        .btn {
            font-size: 0.9rem;
            padding: 10px 20px;
        }

        #stats-panel, .dashboard-stats {
            grid-template-columns: 1fr;
        }
    }
</style>
</head>
<body>
<div class="wrap">
    <!-- START SCREEN -->
    <div id="start-screen">
        <div class="header">
            <h1>ğŸ“œ ë‹¤ì¤‘ì§€ëŠ¥ íƒí—˜: ê³ ëŒ€ì˜ ë¶€ë¦„</h1>
        </div>
        <div class="card">
            <h2>ê³ ëŒ€ì˜ ë¹„ë°€ì„ ì°¾ì•„ ë– ë‚˜ëŠ” ëª¨í—˜</h2>
            <p>ì´ ê²Œì„ì€ 'í•˜ì›Œë“œ ê°€ë“œë„ˆ'ì˜ ë‹¤ì¤‘ì§€ëŠ¥ ì´ë¡ ì„ ê¸°ë°˜ìœ¼ë¡œ ë‹¹ì‹ ì˜ ê°•ì ì„ íƒìƒ‰í•˜ëŠ” ëª¨í—˜ì…ë‹ˆë‹¤. ë‹¹ì‹ ì€ ê³ ëŒ€ ìœ ì ì§€ì—ì„œ ë°œê²¬ëœ ì§€í˜œì˜ ì„œíŒì„ ë”°ë¼ ì‹ ë¹„ë¡œìš´ í€˜ìŠ¤íŠ¸ë¥¼ í•´ê²°í•˜ê²Œ ë©ë‹ˆë‹¤. ê° ì„ íƒì€ ë‹¹ì‹ ì˜ ìˆ¨ê²¨ì§„ ì§€ëŠ¥ì„ ê¹¨ìš°ëŠ” ì—´ì‡ ê°€ ë  ê²ƒì…ë‹ˆë‹¤.</p>
            <div class="input-group">
                <label for="player-name">íƒí—˜ê°€ ì´ë¦„:</label>
                <input type="text" id="player-name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" />
            </div>
            <div class="input-group">
                <label for="player-class">íƒí—˜ê°€ ë°˜:</label>
                <input type="number" id="player-class" placeholder="ë°˜ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 1)" min="1" max="99" />
            </div>
            <button class="btn" onclick="startGame()">ëª¨í—˜ ì‹œì‘í•˜ê¸°</button>
            <button class="btn" onclick="showDashboard()">ëŒ€ì‹œë³´ë“œ ë³´ê¸°</button>
        </div>
    </div>

    <!-- GAME AREA -->
    <div id="game-area">
        <div class="card">
            <h2 id="quest-title"></h2>
            <p id="quest-text"></p>
            <div id="options-container"></div>
        </div>
    </div>

    <!-- STATS AND RESULT AREA -->
    <div id="result-area">
        <div class="card">
            <h2 id="result-title"></h2>
            <p id="result-message"></p>
            <p>ë‹¹ì‹ ì˜ ì§€ëŠ¥ ë¶„í¬ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:</p>
            <div id="stats-panel"></div>
            <p id="result-description" style="margin-top: 20px; font-style: italic;"></p>
            <button class="btn" onclick="showDashboard()">ëŒ€ì‹œë³´ë“œ ë³´ê¸°</button>
            <button class="btn" onclick="resetGame()">ë‹¤ì‹œ ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>
    
    <!-- DASHBOARD AREA -->
    <div id="dashboard-area">
        <div class="header">
            <h2>ì „ì²´ ëª¨í—˜ ê²°ê³¼ ëŒ€ì‹œë³´ë“œ</h2>
        </div>
        <div class="card">
            <div id="dashboard-content">
                <p class="dashboard-loading">ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
            <button class="btn" onclick="resetGame()">ë‹¤ì‹œ ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>

    <div class="footer">
        <p>&copy; ê³ ëŒ€ ìœ ì ì§€, 2025</p>
    </div>
</div>

<script type="module">
    // Firebase imports. Using specific CDN paths for HTML context.
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- FIREBASE SETUP (MANDATORY) ---
    // DO NOT change these variables. They are automatically provided by the platform.
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app;
    let db;
    let auth;
    let userId;
    let isAuthReady = false;

    // A function to get an element by its ID
    const el = id => document.getElementById(id);

    // Initial game state
    let player = {};
    let currentQuestIndex = 0;
    let scores = {
        linguistic: 0,
        logical: 0,
        spatial: 0,
        bodily: 0,
        musical: 0,
        interpersonal: 0,
        intrapersonal: 0,
        naturalist: 0
    };

    // User-provided quests. Do not modify as per user's request.
    const quests = [
        {
            title: "ì²« ë²ˆì§¸ ì„œíŒ: ë¯¸ë¡œì˜ ë°©",
            text: "ê³ ëŒ€ ìœ ì ì§€ ê¹Šìˆ™í•œ ê³³, ë¯¸ë¡œì˜ ë°©ì— ë“¤ì–´ì„°ìŠµë‹ˆë‹¤. ì˜¬ë°”ë¥¸ ê¸¸ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.",
            options: [
                { text: "ì²œì¥ì— ìƒˆê²¨ì§„ ë³„ìë¦¬ ì§€ë„ë¥¼ í•´ë…í•˜ë©° ê¸¸ì„ ì°¾ìŠµë‹ˆë‹¤.", effect: { spatial: 10, logical: 5 } },
                { text: "ë¯¸ë¡œì˜ ë²½ì— ì†ì„ ì–¹ê³  ì¬ì§ˆì˜ ë³€í™”ë¥¼ ëŠë¼ë©° ê¸¸ì„ ì°¾ìŠµë‹ˆë‹¤.", effect: { bodily: 10, naturalist: 5 } },
                { text: "ë‹¤ë¥¸ ì‚¬ëŒì˜ ë°œìêµ­ì´ ê°€ì¥ ë§ì€ ê¸¸ì„ ë”°ë¼ê°‘ë‹ˆë‹¤.", effect: { interpersonal: 10, logical: 5 } },
                { text: "ë¯¸ë¡œ ë²½ì˜ ë‚™ì„œë¥¼ ì½ì–´ ìˆ¨ê²¨ì§„ íŒíŠ¸ë¥¼ ì°¾ìŠµë‹ˆë‹¤.", effect: { linguistic: 10, spatial: 5 } }
            ]
        },
        {
            title: "ë‘ ë²ˆì§¸ ì„œíŒ: ê³ ëŒ€ì˜ í¼ì¦",
            text: "ì¤‘ì•™ í™€ì— ë„ì°©í•˜ë‹ˆ, ê³ ëŒ€ ë¬¸ì–‘ë“¤ì´ ìƒˆê²¨ì§„ ê±°ëŒ€í•œ í¼ì¦ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.",
            options: [
                { text: "ë¬¸ì–‘ì˜ ìˆ˜í•™ì  íŒ¨í„´ì„ ë¶„ì„í•´ í¼ì¦ì„ ë§ì¶¥ë‹ˆë‹¤.", effect: { logical: 10, spatial: 5 } },
                { text: "í¼ì¦ ì¡°ê°ì„ ë§Œì ¸ë³´ë©° ê°ì´‰ì— ë”°ë¼ ì•Œë§ì€ ìœ„ì¹˜ë¥¼ ì°¾ìŠµë‹ˆë‹¤.", effect: { bodily: 10, spatial: 5 } },
                { text: "í¼ì¦ ì¡°ê°ì˜ ëª¨ì–‘ì„ ì‹œê°í™”í•˜ë©° ê³µê°„ì„ ì±„ì›ë‹ˆë‹¤.", effect: { spatial: 10, logical: 5 } },
                { text: "ì£¼ë³€ì— ì í˜€ìˆëŠ” ì‹œë¥¼ ìŠìœ¼ë©° í¼ì¦ì— ë‹µì„ ì°¾ìŠµë‹ˆë‹¤.", effect: { linguistic: 10, musical: 5 } }
            ]
        },
        {
            title: "ì„¸ ë²ˆì§¸ ì„œíŒ: ì¹¨ë¬µì˜ ì „ë‹¹",
            text: "ì–´ë‘ìš´ ì „ë‹¹ì— ë“¤ì–´ì„œì, ì¹¨ë¬µë§Œì´ ê°ë„ëŠ” ê°€ìš´ë° ì‹ ë¹„ë¡œìš´ ì„ ìœ¨ì´ ë“¤ë¦½ë‹ˆë‹¤.",
            options: [
                { text: "ìì‹ ë§Œì˜ ì„ ìœ¨ì„ ë§ë¶™ì—¬ ìƒˆë¡œìš´ ìŒì•…ì„ ì°½ì¡°í•©ë‹ˆë‹¤.", effect: { musical: 10, intrapersonal: 5 } },
                { text: "ì„ ìœ¨ì˜ í™”ìŒì„ ë¶„ì„í•´ ë‹¤ìŒ ìŒê³„ë¥¼ ì˜ˆì¸¡í•©ë‹ˆë‹¤.", effect: { logical: 10, musical: 5 } },
                { text: "ìŒì•…ì˜ ë¦¬ë“¬ì— ë§ì¶° ì¶¤ì„ ì¶”ë©° ì „ë‹¹ì„ ê°€ë¡œì§€ë¦…ë‹ˆë‹¤.", effect: { bodily: 10, musical: 5 } },
                { text: "ìì‹ ì´ ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ìŒì•…ì„ ë– ì˜¬ë¦¬ë©° ë§ˆìŒì„ ë‹¤ìŠ¤ë¦½ë‹ˆë‹¤.", effect: { intrapersonal: 10, musical: 5 } }
            ]
        },
        {
            title: "ë„¤ ë²ˆì§¸ ì„œíŒ: ë¹„ë°€ì˜ ì •ì›",
            text: "ë¹„ë°€ì˜ ì •ì›ì—ëŠ” ë‚¯ì„  ì‹ë¬¼ë“¤ì´ ê°€ë“í•©ë‹ˆë‹¤.",
            options: [
                { text: "ì‹ë¬¼ë“¤ì˜ ìƒê¹€ìƒˆì™€ íŠ¹ì„±ì„ ê´€ì°°í•˜ì—¬ ìˆ¨ê²¨ì§„ ê¸¸ì„ ì°¾ìŠµë‹ˆë‹¤.", effect: { naturalist: 10, spatial: 5 } },
                { text: "ê°€ì¥ ì•„ë¦„ë‹¤ìš´ ê½ƒì„ ì°¾ì•„ í–¥ê¸°ë¥¼ ë§¡ìŠµë‹ˆë‹¤.", effect: { musical: 10, naturalist: 5 } },
                { text: "ì‹ë¬¼ì˜ ì„±ì¥ íŒ¨í„´ì„ ë¶„ì„í•´ ìƒëª…ë ¥ì„ ì´í•´í•©ë‹ˆë‹¤.", effect: { logical: 10, naturalist: 5 } },
                { text: "ì‹ë¬¼ë“¤ê³¼ êµê°í•˜ë©° ì—ë„ˆì§€ë¥¼ ëŠë‚ë‹ˆë‹¤.", effect: { intrapersonal: 10, interpersonal: 5 } }
            ]
        },
        {
            title: "ë‹¤ì„¯ ë²ˆì§¸ ì„œíŒ: ì™•ì˜ íšŒì˜ì‹¤",
            text: "ì™•ì˜ íšŒì˜ì‹¤ì— ë„ì°©í•˜ì ì—¬ëŸ¬ ê°œì˜ ì„ìƒì´ ë‹¹ì‹ ì„ ë°”ë¼ë³´ê³  ìˆìŠµë‹ˆë‹¤.",
            options: [
                { text: "ê°ê°ì˜ ì„ìƒì´ ìƒì§•í•˜ëŠ” ê°ì •ì„ ì´í•´í•˜ê³  ê·¸ë“¤ì˜ ê´€ê³„ë¥¼ íŒŒì•…í•©ë‹ˆë‹¤.", effect: { interpersonal: 10, intrapersonal: 5 } },
                { text: "ì„ìƒë“¤ì˜ ëª¸ì§“ì„ ë”°ë¼í•˜ë©° ê·¸ë“¤ì˜ ì˜ë„ë¥¼ íŒŒì•…í•©ë‹ˆë‹¤.", effect: { bodily: 10, interpersonal: 5 } },
                { text: "ì„ìƒë“¤ ì‚¬ì´ì˜ ì–¸ì–´ì  íŒ¨í„´ì„ ì°¾ì•„ëƒ…ë‹ˆë‹¤.", effect: { linguistic: 10, logical: 5 } },
                { text: "ì„ìƒë“¤ì´ ë°°ì¹˜ëœ ê³µê°„ì˜ ì˜ë¯¸ë¥¼ í•´ì„í•©ë‹ˆë‹¤.", effect: { spatial: 10, interpersonal: 5 } }
            ]
        }
    ];

    // --- CORE GAME LOGIC ---

    // Function to show a specific screen
    function showScreen(screenId) {
        el('start-screen').style.display = 'none';
        el('game-area').style.display = 'none';
        el('result-area').style.display = 'none';
        el('dashboard-area').style.display = 'none';
        el(screenId).style.display = 'block';
    }

    // Start the game
    function startGame() {
        const name = el('player-name').value.trim();
        const playerClass = el('player-class').value.trim();

        if (!name) {
            // Replaced alert with custom modal logic
            showCustomAlert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (!playerClass || isNaN(playerClass) || parseInt(playerClass) < 1) {
            // Replaced alert with custom modal logic
            showCustomAlert('ìœ íš¨í•œ ë°˜ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        player = {
            name: name,
            clazz: parseInt(playerClass)
        };

        // Reset scores for a new game
        Object.keys(scores).forEach(key => scores[key] = 0);
        currentQuestIndex = 0;
        showScreen('game-area');
        loadQuest();
    }

    // Load the current quest
    function loadQuest() {
        if (currentQuestIndex >= quests.length) {
            showResult();
            return;
        }

        const quest = quests[currentQuestIndex];
        el('quest-title').textContent = quest.title;
        el('quest-text').textContent = quest.text;

        const optionsContainer = el('options-container');
        optionsContainer.innerHTML = '';
        quest.options.forEach(option => {
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.textContent = option.text;
            btn.onclick = () => selectOption(option.effect);
            optionsContainer.appendChild(btn);
        });
    }

    // Handle option selection
    function selectOption(effects) {
        for (const key in effects) {
            if (scores[key] !== undefined) {
                scores[key] += effects[key];
            }
        }
        currentQuestIndex++;
        loadQuest();
    }

    // Display the final result
    async function showResult() {
        showScreen('result-area');
        el('result-title').textContent = `ğŸ“œ ëª¨í—˜ì˜ ê²°ê³¼`;
        el('result-message').innerHTML = `<strong>${player.name}</strong>(${player.clazz}ë°˜), ê³ ëŒ€ì˜ ë¶€ë¦„ì— ì‘ë‹µí•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì§€ëŠ¥ ë¶„í¬ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤.`;
        el('result-description').innerHTML = ''; // Clear previous message

        // Display stats bars
        renderStatsBars();

        // Determine top intelligences
        const entries = Object.entries(scores).sort((a, b) => b[1] - a[1]);
        const top1 = entries[0][0];
        const top2 = entries[1][0];
        const mapNames = {
            linguistic: 'ì–¸ì–´ ì§€ëŠ¥',
            logical: 'ë…¼ë¦¬-ìˆ˜í•™ ì§€ëŠ¥',
            spatial: 'ê³µê°„ ì§€ëŠ¥',
            bodily: 'ì‹ ì²´-ìš´ë™ ì§€ëŠ¥',
            musical: 'ìŒì•… ì§€ëŠ¥',
            interpersonal: 'ëŒ€ì¸ê´€ê³„ ì§€ëŠ¥',
            intrapersonal: 'ìê¸°ì´í•´ ì§€ëŠ¥',
            naturalist: 'ìì—°ì¹œí™” ì§€ëŠ¥'
        };
        const description = `ì´ë²ˆ ëª¨í—˜ì„ í†µí•´ <strong>${mapNames[top1]}</strong>ê³¼ <strong>${mapNames[top2]}</strong>ì´(ê°€) ë‹¹ì‹ ì˜ ê°€ì¥ ë†’ì€ ì§€ëŠ¥ì„ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì§€ëŠ¥ë“¤ì„ ê³„ì†í•´ì„œ ë°œì „ì‹œì¼œ ë‚˜ê°€ì„¸ìš”!`;
        el('result-description').innerHTML = description;
        
        // Save results to Firestore
        if (isAuthReady) {
            try {
                const resultsRef = collection(db, `artifacts/${appId}/public/data/multiple_intelligence_results`);
                await addDoc(resultsRef, {
                    name: player.name,
                    class: player.clazz,
                    scores: scores,
                    timestamp: new Date()
                });
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        }
    }

    // Render the stats bars
    function renderStatsBars(targetElementId = 'stats-panel', scoresToRender = scores) {
        const root = el(targetElementId);
        root.innerHTML = ''; // Clear previous bars
        const mapNames = {
            linguistic: 'ì–¸ì–´ ì§€ëŠ¥',
            logical: 'ë…¼ë¦¬-ìˆ˜í•™ ì§€ëŠ¥',
            spatial: 'ê³µê°„ ì§€ëŠ¥',
            bodily: 'ì‹ ì²´-ìš´ë™ ì§€ëŠ¥',
            musical: 'ìŒì•… ì§€ëŠ¥',
            interpersonal: 'ëŒ€ì¸ê´€ê³„ ì§€ëŠ¥',
            intrapersonal: 'ìê¸°ì´í•´ ì§€ëŠ¥',
            naturalist: 'ìì—°ì¹œí™” ì§€ëŠ¥'
        };
        Object.keys(scoresToRender).forEach(k => {
            const score = Math.min(100, Math.max(0, scoresToRender[k]));
            const box = document.createElement('div');
            box.className = 'stat';
            box.innerHTML = `
                <div style="font-weight:bold;color:var(--gold);">${mapNames[k]}</div>
                <div class="bar"><div class="bar-inner" style="width:${score}%"></div></div>
            `;
            root.appendChild(box);
        });
    }
    
    // Reset the game to the start screen
    function resetGame() {
        showScreen('start-screen');
    }

    // --- DASHBOARD LOGIC ---
    function showDashboard() {
        showScreen('dashboard-area');
        const dashboardContent = el('dashboard-content');
        dashboardContent.innerHTML = '<p class="dashboard-loading">ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
        
        if (isAuthReady) {
            const resultsRef = collection(db, `artifacts/${appId}/public/data/multiple_intelligence_results`);
            
            // Listen for real-time updates
            onSnapshot(resultsRef, (querySnapshot) => {
                const resultsByClass = {};
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const classNum = data.class || 'ì•Œ ìˆ˜ ì—†ìŒ';
                    
                    if (!resultsByClass[classNum]) {
                        resultsByClass[classNum] = {
                            count: 0,
                            scores: {
                                linguistic: 0, logical: 0, spatial: 0, bodily: 0,
                                musical: 0, interpersonal: 0, intrapersonal: 0, naturalist: 0
                            }
                        };
                    }
                    
                    resultsByClass[classNum].count++;
                    for (const key in data.scores) {
                        resultsByClass[classNum].scores[key] += data.scores[key];
                    }
                });
                
                renderDashboard(resultsByClass);
            }, (error) => {
                console.error("Error listening to dashboard data: ", error);
                dashboardContent.innerHTML = '<p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            });
        } else {
            dashboardContent.innerHTML = '<p>ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>';
        }
    }

    // Render the dashboard UI
    function renderDashboard(resultsByClass) {
        const dashboardContent = el('dashboard-content');
        dashboardContent.innerHTML = ''; // Clear loading message

        if (Object.keys(resultsByClass).length === 0) {
            dashboardContent.innerHTML = '<p>ì•„ì§ ì €ì¥ëœ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ëª¨í—˜ì„ ì‹œì‘í•´ë³´ì„¸ìš”!</p>';
            return;
        }

        // Sort classes numerically
        const sortedClasses = Object.keys(resultsByClass).sort((a, b) => {
            if (a === 'ì•Œ ìˆ˜ ì—†ìŒ') return 1;
            if (b === 'ì•Œ ìˆ˜ ì—†ìŒ') return -1;
            return parseInt(a) - parseInt(b);
        });

        sortedClasses.forEach(classNum => {
            const classData = resultsByClass[classNum];
            const avgScores = {};
            const mapNames = {
                linguistic: 'ì–¸ì–´ ì§€ëŠ¥', logical: 'ë…¼ë¦¬-ìˆ˜í•™ ì§€ëŠ¥', spatial: 'ê³µê°„ ì§€ëŠ¥', bodily: 'ì‹ ì²´-ìš´ë™ ì§€ëŠ¥',
                musical: 'ìŒì•… ì§€ëŠ¥', interpersonal: 'ëŒ€ì¸ê´€ê³„ ì§€ëŠ¥', intrapersonal: 'ìê¸°ì´í•´ ì§€ëŠ¥', naturalist: 'ìì—°ì¹œí™” ì§€ëŠ¥'
            };

            for (const key in classData.scores) {
                avgScores[key] = (classData.scores[key] / classData.count).toFixed(1);
            }

            const classDashboard = document.createElement('div');
            classDashboard.className = 'class-dashboard';
            classDashboard.innerHTML = `
                <div class="class-header">${classNum}ë°˜ (${classData.count}ëª… ì°¸ì—¬)</div>
                <div class="dashboard-stats">
                    ${Object.keys(avgScores).map(k => `
                        <div class="dashboard-stat">
                            <div class="dashboard-stat-name">${mapNames[k]}</div>
                            <div class="bar"><div class="bar-inner" style="width:${avgScores[k]}%"></div></div>
                        </div>
                    `).join('')}
                </div>
            `;
            dashboardContent.appendChild(classDashboard);
        });
    }

    // Replaced alert with custom modal UI
    function showCustomAlert(message) {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
            z-index: 1000;
        `;
        modal.innerHTML = `
            <div style="background: #fff; padding: 30px; border-radius: 15px; text-align: center; font-size: 1.2rem; font-family: 'Gowun Dodum', sans-serif; color: var(--brown-text);">
                <p>${message}</p>
                <button onclick="this.parentNode.parentNode.remove()" style="padding: 10px 20px; margin-top: 20px; background: var(--btn-bg); color: #fff; border: none; border-radius: 20px; cursor: pointer; font-size: 1rem;">í™•ì¸</button>
            </div>
        `;
        document.body.appendChild(modal);
    }

    // --- INITIALIZATION ---
    async function initFirebase() {
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Sign in using the provided token or anonymously
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("Firebase initialized and user authenticated:", userId);
                } else {
                    console.log("No user authenticated. Using anonymous sign-in.");
                    isAuthReady = true;
                }
            });
        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }
    }

    // Call the initialization function when the window loads
    window.onload = function() {
        initFirebase();
    };

</script>

</body>
</html>
